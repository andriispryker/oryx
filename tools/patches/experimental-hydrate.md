# Lit Experimental Hydrate Patch

This patch fixes two bugs:

- [Hydrating elements](https://github.com/lit/lit/issues/2802) that have a shadow root as its parent and are self closing tags (eg, img)
- [Hydrating elements](https://spryker.atlassian.net/browse/FAAS-2863) rendered through asyncDirective classes

* Affects: lit-html
* Version: 2.2.0

## Files

- experimental-hydrate.patch - for patching experimental-hydrate.js in development mode
- experimental-hydrate.js - replaces the file in default mode

## Updating

- Lit builds the library with two modes: development and default (prod). The patch file fixes the development files but the default build is minified and not suitable for patching, so it's been generated by applying the changes in the lit repo itself, re-building and then using the built files to replace the original file in default mode.

- The patch attempts to fix [this part](https://github.com/lit/lit/blob/main/packages/lit-html/src/experimental-hydrate.ts#L161) of the code by falling back to the `previousSibling` if it does not find the `parentElement` in the case of self-closing tags. It's maybe not necessarily the correct matching element the hydration might be looking for, but it throws no errors and will probably require upstream to look at it.
- The second part of the patch fixes [these lines](https://github.com/lit/lit/blob/main/packages/lit-html/src/experimental-hydrate.ts#L342-L343). The last element in the stack may not necessarily be of type `template-instance` in the case of rendering with `asyncDirective`, so the patch checks for the next `template-instance` state while searching backwards for it.
